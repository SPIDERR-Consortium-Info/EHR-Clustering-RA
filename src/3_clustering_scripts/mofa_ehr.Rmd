---
title: "MOFA_EHR"
author: "Tjardo M"
date: "6/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Set working directory
## Custom environment for packages
```{r}
setwd('/exports/reum/tdmaarseveen/RA_Clustering')
# Set library folder
.libPaths("/exports/reum/tdmaarseveen/Rlibs")
```
```{r}
library(reticulate)
use_condaenv("/exports/reum/tdmaarseveen/convae_architecture/envs", required=TRUE)
```


```{python}
print("versi")
```

## [OPTIONAL] Install Bioconductor Manager and MOFA2
```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("MOFA2")
```


## Load libraries
```{r}
library(data.table)
library(purrr)
library(ggplot2)
library(ggpubr) 
library(MOFA2) #
library("readr")
```

## Import dataset
```{r}
dt <- data.table(read_csv("../../data/6_clustering/df_all_MOVA_no_txt.csv")) # df_all_MOVA_txt.csv if you want to include physician notes
```
# Create subset
```{r}
#pat_sub <- sample(unique(dt$sample), size=650)
#unique(dt$sample)
#dt <- dt[ which(sample %in% pat_sub ),]
```



## Early data analysis
```{r}
head(dt,n=3)

# Views names
unique(dt$view)

# Number of samples
length(unique(dt$sample))

# Remove radio notes (for now...)
dt <- dt[dt$view != "radio_notes", ]

# Number of features per view
dt[,length(unique(feature)),by="view"]
```

```{r}
#ggdensity(dt, x="value", fill="gray70") +
#  facet_wrap(~view, nrow=1, scales="free")
```
## Train MOFA model
```{r}
mofa <- create_mofa(dt)
mofa
```


## Visualize Data structure
```{r}
plot_data_overview(mofa)
```




## Prepare MOFA object
```{r}
# using defatult options, K=15 factors. Maybe increase to a 100?
model_opts <- get_default_model_options(mofa)
model_opts$num_factors <- 50
#model_opts$likelihoods  <- c('gaussian', 'gaussian', 'bernoulli', 'bernoulli') 
model_opts$likelihoods  <- c('gaussian', 'gaussian', 'bernoulli', 'bernoulli') # 'gaussian' if you include physician notes
# 'gaussian', 
mofa <- prepare_mofa(mofa, model_options = model_opts)

# MOFAobject <- prepare_mofa(
#  object = MOFAobject,
#  data_options = data_opts,
#  model_options = model_opts,
#  training_options = train_opts
#)
```

## Train the model
```{r}
set.seed(01072021)
# Run Model
#outfile = file.path(getwd(),"models/mofa_model_k15.hdf5")
#mofa <- run_mofa(mofa, outfile, use_basilisk = FALSE) # we use reticular -> because basilisk installs automatically in root folder
# Load pre-computed model
mofa <- load_model(file.path(getwd(),"models/mofa_model.hdf5"))

```


```{r}
# Using an existing trained model
factors <- get_expectations(mofa, "Z")
weights <- get_expectations(mofa, "W")

write.csv(factors,"/exports/reum/tdmaarseveen/RA_Clustering/results/embedding/mofa_factors.csv", row.names = FALSE)

# Using an existing trained model
write.csv(weights$lab,"/exports/reum/tdmaarseveen/RA_Clustering/results/embedding/mofa_lab_weights.csv", row.names = FALSE)

write.csv(weights$mannequin_counts,"/exports/reum/tdmaarseveen/RA_Clustering/results/embedding/mofa_mannequin_counts_weights.csv", row.names = FALSE)

write.csv(weights$mannequin_ohe,"/exports/reum/tdmaarseveen/RA_Clustering/results/embedding/mofa_mannequin_ohe_weights.csv", row.names = FALSE)

write.csv(weights$serology,"/exports/reum/tdmaarseveen/RA_Clustering/results/embedding/mofa_serology_weights.csv", row.names = FALSE)
```

```{r}
cor <- plot_factor_cor(mofa)
```




# Add sample metadata to the model (e.g. age / demographics)
```{r}
metadata$sample
```


```{r}

#model <- load_model(file)
#model)
metadata <- data.table(read_csv("../../data/6_clustering/df_metadata.csv"))
#metadata <- metadata[ which(sample %in% pat_sub ),]

metadata$sample <- unlist(lapply(metadata$sample, as.character))
samples_metadata(mofa) <- metadata
```


# Downstream analysis

## Variance decomposition
MOFA identified N factors with a minimum explained variance of x%. In  total the latent representation explained N% of heterogeneity in mannequin, Y% of heterogeneity in serology etc..

```{r}
po <- plot_variance_explained(mofa, plot_total = T)[[2]]
po$data
```

```{r}
plot_variance_explained(mofa, plot_total = T)[[2]]
po$data
```


```{r}

```

## Plot variance explained per factor
```{r}
plot_variance_explained(mofa, max_r2=15, min_r2=0.5)
```
```{r}
r2o <- r2 %>%
as.data.table %>% .[,factor:=as.factor(1:mofa@dimensions$K)] %>%
  melt(id.vars=c("factor"), variable.name="view", value.name = "r2") %>%
  .[,cum_r2:=cumsum(r2), by="view"]


# Set limits
minV <- -1; maxV <- 100;

# Limit vector
r2o[, cum_r2] <- sapply(r2o[, cum_r2], function(y) min(max(y,minV),maxV))
```


```{r}
r2 <- mofa@cache$variance_explained$r2_per_factor[[1]]

r2.dt <- r2 %>%
  as.data.table %>% .[,factor:=as.factor(1:mofa@dimensions$K)] %>%
  melt(id.vars=c("factor"), variable.name="view", value.name = "r2") %>%
  .[,cum_r2:=cumsum(r2), by="view"]

ggline(r2.dt, x="factor", y="cum_r2", color="view") +
  labs(x="Factor number", y="Cumulative variance explained (%)") +
  theme(
    legend.title = element_blank(), 
    legend.position = "top",
    axis.text = element_text(size=rel(0.8))
  )
```

```{r}
r2 <- mofa@cache$variance_explained$r2_per_factor[[1]]

r2.dt <- r2 %>%
  as.data.table %>% .[,factor:=as.factor(1:mofa@dimensions$K)] %>%
  melt(id.vars=c("factor"), variable.name="view", value.name = "r2") %>%
  .[,cum_r2:=cumsum(r2), by="view"]

ggline(r2.dt, x="factor", y="cum_r2", color="view") +
  labs(x="Factor number", y="Cumulative variance explained (%)") +
  theme(
    legend.title = element_blank(), 
    legend.position = "top",
    axis.text = element_text(size=rel(0.8))
  )
```


## Visualize MOVA factors

```{r}
p <- plot_factors(mofa, 
  factors = c(4,5), 
  color_by = "RF", 
  dot_size = 4
) 
p
```
```{r}
plot_factors(mofa, factors=1:10, color_by = "aCCP")
```


```{r}
p <- plot_factors(mofa, 
  factors = c(1,2), 
  color_by = "Pijn_pip 3 links hand_negative", 
  dot_size = 4
) 
p
```


## Characterisation of factor 1
```{r}
plot_factor(mofa, 
  factor = 1, 
  color_by = "Category", 
  dot_size = 4,
  dodge = TRUE,
  stroke = 0.4,
  add_violin = T,
  add_boxplot = T
) +
  scale_fill_manual(values=category.colors) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  )
```

## Plot weights per view
```{r}
plot_weights(mofa, factor=2, view="mannequin_ohe", nfeatures=8)
```
```{r}
colnames(metadata)
```


```{r}
set.seed(42)
emb <- plot_dimred(mofa, method="TSNE", return_data=TRUE)
write.csv(emb,"/exports/reum/tdmaarseveen/RA_Clustering/results/embedding/mofa_embedding_tsne.csv", row.names = FALSE)
```
```{r}
set.seed(42)
emb <- plot_dimred(mofa, method="UMAP", color_by='RF', dot_size = 3)
emb
```


```{r}
plot_data_heatmap(mofa, 
  view = "mannequin_ohe", 
  factor = 1, 
  features = 20,
  show_rownames = T, show_colnames = F, 
  cluster_rows = T, cluster_cols = F,
  annotation_samples = "aCCP"
)
```


## Save vectors
```{r}
# Using an existing trained model
file <- system.file("extdata", "model.hdf5", package = "MOFA2")
model <- load_model(file)
factors <- get_expectations(model, "Z")
weights <- get_expectations(model, "W")

```


## Just the top weights
```{r}
plot_top_weights(mofa, 
  view = "radio_notes", 
  factor = 4, 
  nfeatures = 10,
  scale = T, 
  abs = T
) 
```
```{r}
correlate_factors_with_covariates(mofa, 
  covariates = "RF",
  plot = "r",  # use "log_pval" to plot log p-values 
)
```


## Plot feature values - Heatmaps of concentration (no denoising)
```{r}
plot_data_heatmap(mofa, 
  factor = 1, 
  view = "serology", 
  features = 20,
  denoise = FALSE,
  cluster_rows = T, cluster_cols = F,
  show_colnames = F, show_rownames = T,
  annotation_samples = "Category",  
  annotation_colors = list("Category"=category.colors), 
  annotation_legend = F,
  scale = "row"
)
```

## Plot feature values - Heatmaps of concentration (after denoising)
```{r}
plot_data_heatmap(mofa, 
  factor = 1, 
  view = "serology", 
  features = 20,
  denoise = TRUE,
  cluster_rows = T, cluster_cols = F,
  show_colnames = F, show_rownames = T,
  annotation_samples = "Category",  
  annotation_colors = list("Category"=category.colors), 
  annotation_legend = F,
  scale = "row"
)
```

## Scatter plots of concentration for Serological var with largest weight in factor 1, plotted against corresponding factor values
```{r}
plot_data_scatter(mofa, 
  factor = 1, 
  view = "serology", 
  features = 4,
  dot_size = 3,
  color_by = "RF",
  legend = F
)
```

## Association with clinical co-variaes
```{r}
correlate_factors_with_covariates(mofa, 
  covariates = antibiotics,
  plot = "r",  # use "log_pval" to plot log p-values 
)
```

## Correlate factors with covariates (log_pval)
```{r}
correlate_factors_with_covariates(mofa, 
  covariates = metabolites,
  plot = "log_pval",
)
```

## Plot factors coloured by , do we see gradient is captured by a factor??
```{r}
plot_factors(mofa, 
  factors = c(1,3), 
  color_by = "Butyrate", 
  shape_by = "Category", 
  dot_size = 3.5
) + scale_fill_gradient(low = "white", high = "#BF3EFF")
```

